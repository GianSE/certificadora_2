<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hist√≥rico - PitWall IoT</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #121212; color: white; text-align: center; margin: 0; padding: 20px;}
        
        /* Menu de Navega√ß√£o */
        nav { background: #1f1f1f; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        nav a { color: #888; text-decoration: none; margin: 0 15px; font-weight: bold; font-size: 1.1em; transition: 0.3s; }
        nav a:hover, nav a.active { color: #e91e63; }

        /* Controles */
        .filtros { background: #1e1e1e; padding: 20px; border-radius: 15px; display: inline-block; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        
        input[type="datetime-local"], select { 
            padding: 8px; border-radius: 5px; border: none; background: #333; color: white; margin: 5px;
        }
        select { background: #444; font-weight: bold; cursor: pointer; }
        
        button { padding: 8px 15px; background: #e91e63; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-left: 10px;}
        button:hover { background: #c2185b; }

        .chart-container { width: 95%; max-width: 1200px; margin: 0 auto; background: #1e1e1e; padding: 20px; border-radius: 15px; }
    </style>
</head>
<body>

    <nav>
        <a href="/">üèéÔ∏è Cockpit Real-Time</a>
        <a href="/historico" class="active">üìÖ Telemetria Hist√≥rica</a>
    </nav>

    <h1>üìÖ Hist√≥rico de Telemetria</h1>

    <div class="filtros">
        <label>Visualizar:</label>
        <select id="tipo-grafico" onchange="redesenharGrafico()">
            <option value="temp">üå°Ô∏è Temperatura + Bomba</option>
            <option value="umid">üíß Umidade + Exaustor</option>
            <option value="luz">üí° Luminosidade + L√¢mpada</option>
            <option value="tudo">üìä Tudo (Vis√£o Geral)</option>
        </select>

        <br><br>

        <label>De:</label>
        <input type="datetime-local" id="data-inicio">
        <label>At√©:</label>
        <input type="datetime-local" id="data-fim">
        
        <button onclick="buscarDados()">üîç Carregar Dados</button>
    </div>

    <div class="chart-container">
        <canvas id="histChart"></canvas>
    </div>

    <script>
        let chartInstance = null;
        let dadosGlobais = []; // Guarda os dados para n√£o precisar baixar de novo ao trocar o select

        async function buscarDados() {
            const inicio = document.getElementById('data-inicio').value;
            const fim = document.getElementById('data-fim').value;

            if (!inicio || !fim) { alert("Selecione as datas."); return; }

            try {
                const response = await fetch(`/api/historico?inicio=${inicio}&fim=${fim}`);
                dadosGlobais = await response.json(); // Salva na vari√°vel global
                
                if (dadosGlobais.length === 0) { alert("Sem dados no per√≠odo."); return; }
                
                redesenharGrafico(); // Chama a fun√ß√£o que desenha baseado no select
            } catch (e) { console.error(e); alert("Erro ao conectar."); }
        }

        function redesenharGrafico() {
            if (dadosGlobais.length === 0) return;

            const tipo = document.getElementById('tipo-grafico').value;
            const ctx = document.getElementById('histChart').getContext('2d');
            
            // Dados Comuns
            const labels = dadosGlobais.map(d => d.tempo);

            // Prepara os datasets baseados na escolha
            let datasets = [];
            let yAxisConfig = {};

            // --- CONFIGURA√á√ÉO DOS DATASETS ---
            
            // 1. TEMPERATURA + BOMBA
            if (tipo === 'temp' || tipo === 'tudo') {
                datasets.push({
                    label: 'Temp (¬∞C)',
                    borderColor: '#ff6384',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    data: dadosGlobais.map(d => d.temperatura),
                    yAxisID: 'y_esq',
                    tension: 0.4,
                    fill: (tipo !== 'tudo') // S√≥ preenche se for gr√°fico √∫nico
                });
                datasets.push({
                    label: 'Bomba (On/Off)',
                    borderColor: '#4CAF50', 
                    data: dadosGlobais.map(d => d.bomba ? 1 : 0),
                    yAxisID: 'y_dir_status',
                    stepped: true,
                    borderWidth: 2,
                    pointRadius: 0
                });
            }

            // 2. UMIDADE + EXAUSTOR
            if (tipo === 'umid' || tipo === 'tudo') {
                datasets.push({
                    label: 'Umid (%)',
                    borderColor: '#36a2eb',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    data: dadosGlobais.map(d => d.umidade),
                    yAxisID: 'y_esq',
                    tension: 0.4,
                    fill: (tipo !== 'tudo')
                });
                datasets.push({
                    label: 'Exaustor (On/Off)',
                    borderColor: '#FF5722', 
                    data: dadosGlobais.map(d => d.fan ? 1 : 0),
                    yAxisID: 'y_dir_status',
                    stepped: true,
                    borderDash: [5, 5],
                    borderWidth: 2,
                    pointRadius: 0
                });
            }

            // 3. LUMINOSIDADE + L√ÇMPADA
            if (tipo === 'luz' || tipo === 'tudo') {
                datasets.push({
                    label: 'Luminosidade (Lux)',
                    borderColor: '#FFC107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    // --- CORRE√á√ÉO DE INVERS√ÉO ---
                    // Se o sensor d√° 4095 no escuro, fazemos (4095 - valor)
                    // Assim, o gr√°fico sobe quando tem luz.
                    data: dadosGlobais.map(d => 4095 - d.luminosidade), 
                    yAxisID: (tipo === 'tudo') ? 'y_dir_luz' : 'y_esq', // Se for s√≥ luz, usa eixo principal
                    tension: 0.4,
                    fill: (tipo !== 'tudo')
                });
                datasets.push({
                    label: 'Luz Painel (On/Off)',
                    borderColor: '#FFF', 
                    data: dadosGlobais.map(d => d.luz_painel ? 1 : 0),
                    yAxisID: 'y_dir_status',
                    stepped: true,
                    borderDash: [2, 2],
                    borderWidth: 2,
                    pointRadius: 0
                });
            }

            // --- CONFIGURA√á√ÉO DOS EIXOS ---
            yAxisConfig = {
                y_esq: { 
                    type: 'linear', display: true, position: 'left',
                    ticks: { color: '#fff' },
                    title: { display: true, text: 'Valor' }
                },
                y_dir_status: {
                    type: 'linear', display: true, position: 'right',
                    min: 0, max: 1.5, // Deixa o status baixinho no gr√°fico
                    display: false // Esconde n√∫meros
                }
            };

            // Se estiver vendo tudo junto, precisamos de um terceiro eixo para a Luz (0-4095)
            if (tipo === 'tudo') {
                yAxisConfig.y_dir_luz = {
                    type: 'linear', display: true, position: 'right',
                    ticks: { color: '#FFC107' },
                    grid: { drawOnChartArea: false }
                };
            }

            // --- CRIA√á√ÉO DO GR√ÅFICO ---
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { ticks: { color: '#888' }, grid: { color: '#333' } },
                        ...yAxisConfig
                    },
                    plugins: { legend: { labels: { color: 'white' } } }
                }
            });
        }
    </script>
</body>
</html>